---
title: "HH Simulation charts"
output: html_notebook
---


```{r}
library(ggplot2)
library(tidyverse)
library(plotly)
library(gridExtra)
```


```{r}
deposits <- read.csv("deposits.csv")

states <- read.csv("states.csv")
#states$Borrowed <- as.numeric(states$Borrowed) / 1e18
#states$Supplied <- as.numeric(states$Supplied) / 1e18
states$Collateral <- as.numeric(states$Collateral) / 1e18


swaps <- read.csv("swaps.csv")
swaps$Amount <- as.numeric(swaps$Amount) / 1e18
swaps$Zero.For.One <- as.logical(swaps$Zero.For.One)

# Displaying the first few rows of each data frame to confirm
#head(deposits)
#head(states)
#head(swaps)
dim(swaps)
dim(states)
```

```{r}
# Select the first occurrence of each Block Number in states
states_first <- states %>%
  group_by(Block.Number) %>%
  slice(1) %>%
  ungroup()


merged_data <- left_join(swaps, states_first, by = "Block.Number")
merged_data$Amount <- ifelse(merged_data$Zero.For.One == FALSE, -merged_data$Amount, merged_data$Amount)
```


```{r}
q = 2**96
merged_data$price <- 1e12/(merged_data$SqrtPriceX96/q)**2
```

```{r}
p_price <- ggplot(merged_data, aes(x = Block.Number, y = price)) + 
  geom_line(color = "green", size = 1) +
  labs(title = "Price Chart", y = "Price") +
  theme_minimal()

# Create the trading volume bar chart
p_volume <- ggplot(merged_data, aes(x = Block.Number, y = Amount)) +
  geom_bar(stat = "identity", fill = "blue", alpha = 0.7) +
  labs(title = "Trading Volume (Amount)", y = "Amount") +
  theme_minimal()

# Convert ggplot objects to plotly objects
p_price_plotly <- ggplotly(p_price)
p_volume_plotly <- ggplotly(p_volume)

# Combine the two plots into one figure with specified heights and shared x-axis
combined_plot <- subplot(
  p_price_plotly, p_volume_plotly,
  nrows = 2,
  shareX = TRUE,
  heights = c(0.7, 0.3)  # 70% height for the price chart and 30% for the volume chart
) %>%
  layout(
    title = "Pool ALM",
    xaxis = list(
      title = "Block Number", 
      rangeslider = list(
        visible = TRUE, 
        thickness = 0.02  # Adjust thickness of the range slider to reduce height
      )
    ),
    yaxis = list(title = "Price"),  # Y-axis for the price chart
    yaxis2 = list(title = "Amount")  # Y-axis for the volume chart
  )

# Show the combined plot
combined_plot
```


