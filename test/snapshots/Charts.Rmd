---
title: "HH Simulation charts"
output: html_notebook
---


```{r}
library(ggplot2)
library(tidyverse)
library(plotly)
library(gridExtra)
library(knitr)
library(dplyr)
```


```{r}
rm(list = ls())
deposits <- read.csv("deposits.csv")

states <- read.csv("states.csv")
states$Collateral <- as.numeric(states$Collateral) / 1e18


swaps <- read.csv("swaps.csv")
swaps$zeroForOne <- as.logical(swaps$zeroForOne)
swaps$In <- as.logical(swaps$In)
swaps$Amount <- ifelse(
  (swaps$zeroForOne & swaps$In) | (!swaps$zeroForOne & !swaps$In),
  as.numeric(swaps$Amount) / 1e6,
  as.numeric(swaps$Amount) / 1e18
)

swaps$delta0 = as.numeric(swaps$delta0) / 1e6
swaps$delta0c = as.numeric(swaps$delta0c) / 1e6

swaps$delta1 = as.numeric(swaps$delta1) / 1e18
swaps$delta1c = as.numeric(swaps$delta1c) / 1e18


#head(deposits)
dim(swaps)
dim(states)
```

```{r}
# Select the first occurrence of each Block Number in states
states_first <- states %>%
  group_by(blockNumber) %>%
  slice(1) %>%
  ungroup()

merged_data <- left_join(swaps, states_first, by = "blockNumber")
```


```{r}
q = 2**96
merged_data$price <- 1e12/(merged_data$SqrtPriceX96/q)**2
merged_data$priceC <- 1e12/(merged_data$SqrtPriceX96c/q)**2
```


## Swap sqrtPrice with control comparison
```{r}
# Plot the price chart with both 'price' and 'priceC' lines
p_price <- ggplot(merged_data) +
  geom_line(aes(x = blockNumber, y = price), color = "green", size = 1) +
  geom_line(aes(x = blockNumber, y = priceC), color = "red", size = 1, linetype = "dashed") +  # Add 'priceC' line
  labs(title = "Price Chart", y = "Price") +
  theme_minimal()

# Create the trading volume bar chart
p_volume <- ggplot(merged_data, aes(x = blockNumber, y = delta1)) +
  geom_bar(stat = "identity", fill = "blue", alpha = 0.7) +
  labs(title = "Trading Volume (Amount)", y = "Amount") +
  theme_minimal()

# Convert ggplot objects to plotly objects
p_price_plotly <- ggplotly(p_price)
p_volume_plotly <- ggplotly(p_volume)

# Combine the two plots into one figure with specified heights and shared x-axis
combined_plot <- subplot(
  p_price_plotly, p_volume_plotly,
  nrows = 2,
  shareX = TRUE,
  heights = c(0.7, 0.3)  # 70% height for the price chart and 30% for the volume chart
) %>%
  layout(
    title = "Pool ALM",
    xaxis = list(
      title = "Block Number", 
      rangeslider = list(
        visible = TRUE, 
        thickness = 0.02  # Adjust thickness of the range slider to reduce height
      )
    ),
    yaxis = list(title = "Price"),  # Y-axis for the price chart
    yaxis2 = list(title = "Amount")  # Y-axis for the volume chart
  )

# Show the combined plot
combined_plot
```


## Swap deltas with control comparison
```{r}
# Create the delta0 and delta0c bar chart
p_delta0 <- ggplot(swaps) +
  geom_bar(aes(x = blockNumber, y = delta0), stat = "identity", fill = "green", alpha = 0.7) +
  geom_bar(aes(x = blockNumber, y = delta0c), stat = "identity", fill = "orange", alpha = 0.5) +
  labs(title = "Delta0 and Delta0c (Amount)", y = "Amount") +
  theme_minimal()

# Create the delta1 and delta1c bar chart
p_delta1 <- ggplot(swaps) +
  geom_bar(aes(x = blockNumber, y = delta1), stat = "identity", fill = "blue", alpha = 0.7) +
  geom_bar(aes(x = blockNumber, y = delta1c), stat = "identity", fill = "purple", alpha = 0.5) +
  labs(title = "Delta1 and Delta1c (Amount)", y = "Amount") +
  theme_minimal()

# Convert ggplot objects to plotly objects
p_delta0_plotly <- ggplotly(p_delta0)
p_delta1_plotly <- ggplotly(p_delta1)

# Combine the two bar plots into one figure with specified heights and shared x-axis
combined_plot <- subplot(
  p_delta0_plotly, p_delta1_plotly,
  nrows = 2,
  shareX = TRUE,
  heights = c(0.5, 0.5)  # Adjust heights if needed, here it's split equally
) %>%
  layout(
    title = "Delta0 and Delta1 Comparison with Delta0c and Delta1c",
    xaxis = list(
      title = "Block Number",
      rangeslider = list(
        visible = TRUE,
        thickness = 0.02
      )
    ),
    yaxis = list(title = "delta0"),  # Y-axis for Delta0 and Delta0c
    yaxis2 = list(title = "delta1")  # Y-axis for Delta1 and Delta1c
  )

# Show the combined plot
combined_plot
```
```{r}
swaps <- swaps %>%
  mutate(
    abs_diff_delta0 = abs(delta0 - delta0c),
    abs_diff_delta1 = abs(delta1 - delta1c)
  )

p_abs_diff_delta0 <- ggplot(swaps) +
  geom_bar(aes(x = blockNumber, y = abs_diff_delta0), stat = "identity", fill = "green", alpha = 0.7) +
  labs(title = "abs diff d0", y = "AD") +
  theme_minimal()

p_abs_diff_delta1 <- ggplot(swaps) +
  geom_bar(aes(x = blockNumber, y = abs_diff_delta1), stat = "identity", fill = "blue", alpha = 0.7) +
  labs(title = "abs diff d1", y = "AD") +
  theme_minimal()

# Convert ggplot objects to plotly objects
p_abs_diff_delta0_plotly <- ggplotly(p_abs_diff_delta0)
p_abs_diff_delta1_plotly <- ggplotly(p_abs_diff_delta1)

# Combine the two bar plots into one figure with specified heights and shared x-axis
combined_plot <- subplot(
  p_abs_diff_delta0_plotly, p_abs_diff_delta1_plotly,
  nrows = 2,
  shareX = TRUE,
  heights = c(0.5, 0.5)
) %>%
  layout(
    title = "Absolute Differences for Delta0 and Delta1 vs control",
    xaxis = list(
      title = "Block Number",
      rangeslider = list(
        visible = TRUE,
        thickness = 0.02
      )
    ),
    yaxis = list(title = "abs diff d0"),
    yaxis2 = list(title = "abs diff d1")
  )

# Show the combined plot
combined_plot
```
```{r}
# Plot the share price chart with both 'sharePrice' and 'sharePriceControl' lines
states_1 <- states
states_1$tvl <-  states_1$tvl/1e18
states_1$tvlControl <-  states_1$tvlControl/(1e18*2)

states_1$sharePrice <- states_1$sharePrice/ 1e18
states_1$sharePriceControl <-  states_1$sharePriceControl/(1e18)
# Plot the share price chart with both 'sharePrice' and 'sharePriceControl' lines
p_sharePrice <- ggplot(states_1) +
  geom_line(aes(x = blockNumber, y = sharePrice), color = "green", size = 1) +
  geom_line(aes(x = blockNumber, y = sharePriceControl), color = "red", size = 1, linetype = "dashed") +
  labs(title = "Share Price Chart", y = "Share Price") +
  theme_minimal()

# Convert ggplot object to plotly object
p_sharePrice_plotly <- ggplotly(p_sharePrice)

# Display only the share price plot
combined_plot <- p_sharePrice_plotly %>%
  layout(
    title = "Pool ALM",
    xaxis = list(
      title = "Block Number", 
      rangeslider = list(
        visible = TRUE, 
        thickness = 0.02  # Adjust thickness of the range slider to reduce height
      )
    ),
    yaxis = list(title = "Share Price")  # Y-axis for the share price chart
  )

# Show the plot
combined_plot

```

